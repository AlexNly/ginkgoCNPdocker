#!/bin/bash

###TO CHECK
###1 - If user specifies facs file, "facs" variable is not set...

## == Setup variables ===============================
home=/mnt/data/ginkgo
dir=${home}/uploads/${1}
source ${dir}/config
distMet=$distMeth
touch $dir/index.html

inFile=list
statFile=status.xml
genome=${home}/genomes/${chosen_genome}

## == Analysis ===========================================


############################################################
########## Error Check and Reformat User Files #############
############################################################

if [ "$f" == "0" ]; then
  touch ${dir}/ploidyDummy.txt
  facs=ploidyDummy.txt
else 
  sed "s/.bed//g" ${dir}/${facs} | sort -k1,1 | awk '{print $1"\t"$2}' > ${dir}/quickTemp 
  mv ${dir}/quickTemp ${dir}/${facs}
fi


############################################################
####### Map Reads & Prepare Samples For Processing #########
############################################################

total=`wc -l < ${dir}/${inFile}`

if [ "$init" == "1" ]; then

  #Clean directory
  rm -f ${dir}/*_mapped ${dir}/*.jpeg ${dir}/*.newick ${dir}/*.xml ${dir}/Seg* ${dir}/results.txt

  #Map user bed files to appropriate bins
  cnt=0
  while read file; do
    ${home}/scripts/status ${dir}/${statFile} 1 $file $cnt $total
    ${home}/scripts/binUnsorted ${genome}/${binMeth} `wc -l < ${genome}/${binMeth}` ${dir}/${file} `echo ${file} | sed "s/.bed//g"` ${dir}/${file}_mapped
    cnt=$(($cnt+1))
  done < ${dir}/${inFile}

  #Concatenate binned reads to central file  
  paste ${dir}/*_mapped > ${dir}/data
  rm -f ${dir}/*_mapped ${dir}/*_binned

fi


############################################################
##### Map User Provided Reference/Segmentation Sample ######
############################################################

if [ "$segMeth" == "2" ]; then
    ${home}/scripts/binUnsorted ${genome}/${binMeth} `wc -l < ${genome}/${binMeth}` ${dir}/${ref} Reference ${dir}/${ref}_mapped
else
    ref=refDummy.bed
    touch ${dir}/${ref}_mapped
fi


############################################################
######### Run Mapped Data Through Primary Pipeline #########
############################################################

if [ "$process" == "1" ]; then
  ${home}/scripts/process.R $genome $dir $statFile data $segMeth $binMeth $clustMeth $distMet $color ${ref}_mapped $f $facs $sex 
fi

############################################################
#### Recreate Clusters/Heat Maps (With New Parameters) #####
############################################################

if [ "$fix" == "1" ]; then
  ${home}/scripts/reclust.R $genome $dir $statFile $binMeth $clustMeth $distMet $f $facs $sex
fi

############################################################
############# Email notification of completion #############
############################################################

if [ "$email" != "" ]; then
	echo -e "Your analysis on Ginkgo is complete! Check out your results at $permalink" | mail -s "Your Analysis Results" $email -- -F "Ginkgo"
fi
