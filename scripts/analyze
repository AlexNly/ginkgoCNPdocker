#!/bin/bash

## == Sample Variables ===================================
#user=sample
#
#segMeth=0
#binMeth=orig
#clustMeth=single
#distMeth=euclidian
#
#init=1
#process=1
#fix=0
#b=0
#binList=binQuery
#f=1
#facs=ploidy.txt
#g=1
#geneList=geneQuery
#chosen_genome="hg18"
#
#email="raboukha@cshl.edu"
#permalink="http://qb.cshl.edu/ginkgo?q=dashboard/robert"

## == Setup more variables ===============================
home=/mnt/data/ginkgo
dir=${home}/uploads/${1}
source ${dir}/config

inFile=list
statFile=status.xml
genome=${home}/genomes/${chosen_genome}

## == Analysis ===========================================

total=`wc -l < ${dir}/${inFile}`

if [ $init -eq 1 ]; then

  cnt=0;

  #Map user bed files to appropriate bins
  while read file; do
    ${home}/scripts/status ${dir}/${statFile} 1 $file $cnt $total
    ${home}/scripts/binUnsorted ${genome}/${binMeth} `wc -l < ${genome}/${binMeth}` ${dir}/${file} `echo ${file} | sed "s/.bed//g"` ${dir}/${file}_mapped
    cnt=$(($cnt+1));
  done < ${dir}/${inFile}

  #Concatenate binned reads to central file and clean directory
  paste ${genome}/${binMeth} ${dir}/*_mapped > ${dir}/data
  rm -f ${dir}/*jpeg ${dir}/*_mapped ${dir}/hist* ${dir}/Seg*

  #Generate Statistics
  ${home}/scripts/stats.R $dir statFile ${dir}/data

fi

if [ $process -eq 1 ]; then

  ${home}/scripts/status ${dir}/${statFile} 2 Initializing 0 1

  #Process binned data
  if [ $f -eq 1 ]; then
    ${home}/scripts/facs.R $genome $dir $statFile data $binMeth $segMeth $clustMeth $distMeth $facs
  else
    ${home}/scripts/finish.R $genome $dir $statFile data $binMeth $segMeth $clustMeth $distMeth
  fi

fi

#Replot histogram when user changes clustering method or distance metric
if [ $fix -eq 1 ]; then
  ${home}/scripts/fix.R $dir $statFile SegFile $clustMeth $distMeth $f
fi

#Plot queried genes
if [ $g -eq 1 ]; then
  if [ $f -eq 1 ]; then
    ${home}/scripts/facs2.R $genome $dir $statFile data $binMeth $geneList
  else
    ${home}/scripts/finish2.R $genome $dir $statFile data $binMeth $geneList
  fi
fi

#Write genes in queried bins to bed file
if [ $b -eq 1 ]; then
  ${home}/scripts/bin2Genes ${genome}/$binMeth ${genome}/genes ${dir}/$binList ${dir}/bin2Genes.bed
fi

echo -e "Your analysis on Ginkgo is complete! Check out your results at $permalink" | mail -s "Your Analysis Results" $email -- -F "Ginkgo"



